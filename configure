if ! test -z $DEVTOOLS_LOAD; then
  # with DEVTOOLS load we don't try to find cmake from the path because
  # configure uses the shell path which is often not the same as the terminal path.
  CMAKE=cmake
elif [ `uname` = "Darwin" ]; then
  if test -z "$CMAKE"; then CMAKE="`which cmake`"; fi
  if test -z "$CMAKE"; then CMAKE=/Applications/CMake.app/Contents/bin/cmake; fi
else
  # in other OS's cmake is expected to be on the PATH
  CMAKE=cmake
fi

##################################################################################
## Link to extra libs on the machine
##  - Mac: Metal/Accelerate
##  - NVIDIA CUDA libs
##
if [ `uname` = "Darwin" ]; then
  ## Computer has a GPU based on Metal
  EXT_PKG_LIBS = -framework Foundation -framework Metal -framework MetalKit
  ## Computer has Mac Accelerate framework
  EXT_PKG_LIBS += -framework Accelerate
else
  EXT_PKG_LIBS="${WHISPER_EXTRA_PKG_LIBS:-}"
fi
if [ -z "$WHISPER_EXTRA_PKG_LIBS" ] && [ -n "$WHISPER_EXTRA_PKG_LIBS" ]; then
  EXT_PKG_LIBS="${WHISPER_EXTRA_PKG_LIBS:-}"
fi

##################################################################################
## cmake settings for whisper.cpp
##
CMAKE_FLAGS_EXTRA="${WHISPER_CMAKE_FLAGS:-}"
CMAKE_FLAGS="-DGGML_BLAS=1 -DGGML_CUDA=0 -DGGML_METAL=0 -DGGML_OPENCL=0 -DGGML_OPENMP=1 -DGGML_QNNPACK=0 -DGGML_USE_ACCELERATE=0 -DGGML_USE_CUDA_NVCC=0 -DGGML_USE_LIBBACKTRACE=0 -DGGML_USE_MKL=0 -DGGML_USE_OPENBLAS=1 -DGGML_USE_VECLIB=0 -DWHISPER_BUILD_TESTS=0 -DCMAKE_BUILD_TYPE=Release"
CMAKE_FLAGS=" -DBUILD_SHARED_LIBS=OFF -DWHISPER_STANDALONE=ON -DWHISPER_BUILD_EXAMPLES=OFF -DWHISPER_BUILD_TESTS=OFF -DGGML_NATIVE=OFF"
CMAKE_FLAGS=" -DBUILD_SHARED_LIBS=OFF -DWHISPER_STANDALONE=ON -DWHISPER_BUILD_EXAMPLES=OFF -DWHISPER_BUILD_TESTS=OFF -DGGML_NATIVE=ON"
CMAKE_FLAGS=" -DBUILD_SHARED_LIBS=OFF -DWHISPER_STANDALONE=ON -DWHISPER_BUILD_EXAMPLES=OFF -DWHISPER_BUILD_TESTS=OFF -DGGML_NATIVE=ON -DGGML_AVX2=ON -DGGML_FMA=ON -DGGML_F16C=ON"
CMAKE_FLAGS=" -DBUILD_SHARED_LIBS=OFF -DWHISPER_STANDALONE=ON -DWHISPER_BUILD_EXAMPLES=OFF -DWHISPER_BUILD_TESTS=OFF -DGGML_NATIVE=ON -DMSVC=1"
CMAKE_FLAGS=" -DBUILD_SHARED_LIBS=OFF -DWHISPER_STANDALONE=ON -DWHISPER_BUILD_EXAMPLES=OFF -DWHISPER_BUILD_TESTS=OFF -DGGML_NATIVE=0 -DGGML_SSE42=0 -DGGML_F16C=1 -DGGML_FMA=1 -DGGML_BMI2=0 -DGGML_AVX=0 -DGGML_AVX2=1"
CMAKE_FLAGS=" -DBUILD_SHARED_LIBS=OFF -DWHISPER_STANDALONE=OFF -DWHISPER_BUILD_EXAMPLES=OFF -DWHISPER_BUILD_TESTS=OFF -DCMAKE_POSITION_INDEPENDENT_CODE:bool=ON $CMAKE_FLAGS_EXTRA"
#CMAKE_CXX_FLAGS "-Wall -Wextra"
#CMAKE_CXX_FLAGS_DEBUG "-g"
#CMAKE_CXX_FLAGS_RELEASE "-O3"
echo "Using cmake to compile whisper.cpp"
echo "  - You provided the following extra flags in WHISPER_CMAKE_FLAGS: $WHISPER_CMAKE_FLAGS"
echo "  - Compiling with the following combined CMAKE_FLAGS: $CMAKE_FLAGS"

cd src
if [ -d build ]; then
  rm -r build
fi
mkdir build
cmake -G "Unix Makefiles" -S ../inst/whisper.cpp -B build $CMAKE_FLAGS
cmake --build build --config Release --target whisper

WHISPER_STATIC_LIBS=$(Rscript -e "cat(file.path('.', list.files(recursive = T, pattern = '[.]a$')), sep = ' ')")
WHISPER_STATIC_LIBS=$(Rscript -e "base = c(list.files(recursive = T, pattern = 'libwhisper.a$'), list.files(recursive = T, pattern = 'libggml.a$'), list.files(recursive = T, pattern = 'libggml-base.a$'), list.files(recursive = T, pattern = 'libggml-metal.a$'), list.files(recursive = T, pattern = 'libggml-blas.a$'), list.files(recursive = T, pattern = 'libggml-cpu.a$'));all = list.files(recursive = T, pattern = '[.]a$');cat(file.path('.', c(base, setdiff(all, base))), sep = ' ')")
echo "Static libs generated using cmake: $WHISPER_STATIC_LIBS"
#WHISPER_STATIC_LIBS="$WHISPER_STATIC_LIBS $EXT_PKG_LIBS"
sed -e "s|@CMAKE@|$CMAKE|" -e "s|@CMAKE_FLAGS@|$CMAKE_FLAGS|" -e "s|@WHISPER_STATIC_LIBS@|$WHISPER_STATIC_LIBS|" -e "s|@RCPP_HOME_DIR@|$RCPP_HOME_DIR|" Makevars.in > Makevars
cat Makevars
